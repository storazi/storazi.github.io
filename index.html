<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>미궁 서버 펫 확률 계산기</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <style>
    .container { margin-top: 20px; color:#eaf2ff; background:#0b1220; padding:30px; border-radius:10px; }
    .form-control { width: auto; display: inline-block; background:#121a2b; border:1px solid #24324b; color:#eaf2ff; }
    table { margin-top: 20px; background:#121a2b; }
    .panel-info>.panel-heading{background:#24324b;color:#eaf2ff;}
    .panel-body{background:#121a2b;color:#a9b5cc;}
  </style>
</head>
<body>

<div class="container">
  <h2>🐾 미궁 서버 펫 확률 계산기</h2>
  <hr>

  <div class="panel panel-info">
    <div class="panel-heading"><strong>사용법</strong></div>
    <div class="panel-body">
      ① 펫 이름을 선택하면 성장률이 자동으로 불러와집니다.<br>
      ② 초기치를 입력하면 내부 계산으로 성공 확률(%)을 보여줍니다.
    </div>
  </div>

  <div>
    <label>펫 이름</label>
    <select id="petSelect" class="form-control">
      <option value="">-- 펫 선택 --</option>
    </select>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>구분</th>
          <th>HP</th>
          <th>Atk</th>
          <th>Def</th>
          <th>Agi</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>초기치</td>
          <td><input type="number" class="form-control" id="statHp" placeholder="예: 52"></td>
          <td><input type="number" class="form-control" id="statAtk" placeholder="예: 12"></td>
          <td><input type="number" class="form-control" id="statDef" placeholder="예: 7"></td>
          <td><input type="number" class="form-control" id="statAgi" placeholder="예: 6"></td>
          <td><button type="button" class="btn btn-primary" id="calculate">계산하기</button></td>
        </tr>
        <tr>
          <td>성장률 (자동)</td>
          <td id="growHp">-</td>
          <td id="growAtk">-</td>
          <td id="growDef">-</td>
          <td id="growAgi">-</td>
          <td></td>
        </tr>
        <tr id="resultRow" style="display:none;">
          <td><strong>결과</strong></td>
          <td colspan="5" id="resultValue"></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const RANKS = [435,455,475,495,515,535,555,575];

// 소수 둘째자리까지 “수치 동일” 비교
const eq2 = (a, b) => Math.abs(Number(a.toFixed(2)) - Number(b.toFixed(2))) < 0.005;

// initnum, base → 초기 실수 스탯
function initStat(initnum, base){ return initnum * (base + 4.5) / 100; }

// base, rank → 성장률
function growFrom(base, rank){ return ((base + 4.5) * rank) / 10000; }

// 한 후보(initnum, 4베이스)가 입력 초기치를 만족하는지 검사
function matchInitials(initnum, hb, ob, db, ab, IHP, IATK, IDEF, IAGI){
  const H = initStat(initnum, hb);
  const O = initStat(initnum, ob);
  const D = initStat(initnum, db);
  const A = initStat(initnum, ab);

  // 표기 규칙(문제에서 쓰던 정수화)
  const shownHP  = Math.floor(H*4 + O + D + A);
  const shownATK = Math.floor(H*0.1 + O + D*0.1 + A*0.05);
  const shownDEF = Math.floor(H*0.1 + O*0.1 + D + A*0.05);
  const shownAGI = Math.floor(A);

  return (shownHP===IHP && shownATK===IATK && shownDEF===IDEF && shownAGI===IAGI);
}

// 해당 후보가 주어진 펫 성장률 4개와 일치하는 랭크가 몇 개인지
function countRankMatches(hb, ob, db, ab, grow){
  let hit = 0;
  for(const r of RANKS){
    const gH = growFrom(hb, r);
    const gO = growFrom(ob, r);
    const gD = growFrom(db, r);
    const gA = growFrom(ab, r);
    if (eq2(gH, grow.H) && eq2(gO, grow.O) && eq2(gD, grow.D) && eq2(gA, grow.A)) hit++;
  }
  return hit;
}

// 메인: 전수로 후보 찾고 확률 계산
async function calcProbability(){
  // 선택 펫/입력값 가져오기
  const name = document.getElementById("petSelect").value.trim();
  const pet  = (window.pets||[]).find(p => p.Name.trim()===name);
  if(!pet){ alert("펫을 먼저 선택해주세요."); return; }

  const IHP  = parseInt(document.getElementById("hpInput").value,10);
  const IATK = parseInt(document.getElementById("atkInput").value,10);
  const IDEF = parseInt(document.getElementById("defInput").value,10);
  const IAGI = parseInt(document.getElementById("agiInput").value,10);
  if([IHP,IATK,IDEF,IAGI].some(v=>Number.isNaN(v))){
    alert("초기치를 모두 입력해주세요."); return;
  }

  const grow = pet.Grow; // {H,O,D,A}

  let candidates = 0;
  let success = 0;

  // 1) 아지로 1차 가지치기
  for(let initnum=10; initnum<=30; initnum++){
    for(let ab=0; ab<=60; ab++){
      const A = initStat(initnum, ab);
      if (Math.floor(A)!==IAGI) continue; // 아지 안맞으면 skip

      // 2) HP/Atk/Def 베이스 전수 (0..60), 초기치 정확 매칭만 채택
      for(let hb=0; hb<=60; hb++){
        for(let ob=0; ob<=60; ob++){
          for(let db=0; db<=60; db++){
            if (!matchInitials(initnum, hb, ob, db, ab, IHP, IATK, IDEF, IAGI)) continue;
            candidates++;

            // 3) 8랭크 중 펫 성장률 4개가 모두 맞는 랭크 수
            success += countRankMatches(hb, ob, db, ab, grow);
          }
        }
      }
    }
  }

  // 후보×랭크가 전체 경우의 수
  const total = candidates * RANKS.length;
  const prob = total>0 ? (success/total*100) : 0;

  const box = document.getElementById("resultBox");
  box.style.display = "block";
  box.textContent = `성공 확률 : ${prob.toFixed(2)}% (${success}/${total})`;
}

// ▼ 이 IDs가 페이지에 있어야 함(입력칸/버튼/결과창)
document.getElementById("calcBtn").addEventListener("click", calcProbability);

// 선택 시 입력칸 자동 채우기(초기치가 있으면 세팅, 성장률 표시는 그대로)
document.getElementById("petSelect").addEventListener("change", (e)=>{
  const pet = (window.pets||[]).find(p=>p.Name===e.target.value);
  if(!pet) return;
  // 필요 시 placeholder만 채우고, 값은 사용자가 적는 구조면 아래 두 줄 주석 처리
  document.getElementById("hpInput").value  = Math.floor(pet.Init.HP*4 + pet.Init.Op + pet.Init.Dp + pet.Init.Ap);
  document.getElementById("atkInput").value = Math.floor(pet.Init.HP*0.1 + pet.Init.Op + pet.Init.Dp*0.1 + pet.Init.Ap*0.05);
  document.getElementById("defInput").value = Math.floor(pet.Init.HP*0.1 + pet.Init.Op*0.1 + pet.Init.Dp + pet.Init.Ap*0.05);
  document.getElementById("agiInput").value = Math.floor(pet.Init.Ap);
  // 성장률 표시도 갱신(표 셀 id는 기존 페이지에 맞춰두기)
  document.getElementById("growH").textContent = pet.Grow.H;
  document.getElementById("growO").textContent = pet.Grow.O;
  document.getElementById("growD").textContent = pet.Grow.D;
  document.getElementById("growA").textContent = pet.Grow.A;
});
</script>


</body>
</html>
