<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í« ê³„ì‚°ê¸° (ê²½í—˜ì¹˜ + ì´ˆê¸°í™” ì‹œë®¬ë ˆì´í„°)</title>
<style>
:root{
  --bg:#0b1220; --panel:#121a2b; --soft:#1c2538; --ring:#24324b;
  --text:#eaf2ff; --muted:#a9b5cc; --accent:#6aa0ff;
  --ok:#36d17b; --warn:#ffbd4a; --bad:#ff6b81;
}
body{background:var(--bg);color:var(--text);font-family:Pretendard,system-ui,sans-serif;margin:0}
h1{margin:18px 0 6px 0;text-align:center;color:var(--accent)}
.tabs{display:flex;gap:8px;justify-content:center}
.tab{background:var(--panel);border:1px solid var(--ring);border-radius:8px;padding:8px 18px;cursor:pointer;color:var(--muted);font-weight:600}
.tab.active{background:var(--accent);color:#fff}
.panel{display:none;margin:15px auto;background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:20px;width:92%;max-width:820px}
.panel.active{display:block}
label{display:inline-block;width:140px;color:var(--muted)}
input[type="number"],input[type="text"]{width:140px;padding:6px;background:var(--soft);border:1px solid var(--ring);border-radius:6px;color:var(--text);margin:3px 0}
button{margin-top:10px;padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600}
button:hover{filter:brightness(1.2)}
.result{margin-top:10px;color:var(--ok);font-weight:600}
.combo-box{background:var(--panel);border:1px solid var(--ring);border-radius:12px;padding:12px;margin-top:10px}
.combo-box span{display:inline-block;margin-right:8px}
.muted{color:var(--muted)}
.prob{color:var(--ok);font-weight:700}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
input[type="file"]{margin-left:6px}
hr{border:none;border-top:1px solid var(--ring);margin:18px 0}
</style>
</head>
<body>

<h1>ğŸ¾ í« ê³„ì‚°ê¸°</h1>
<div class="tabs">
  <div class="tab active" data-tab="exp">ğŸ“˜ ê²½í—˜ì¹˜ ê³„ì‚°ê¸°</div>
  <div class="tab" data-tab="sim">ğŸ² í« ì´ˆê¸°í™” ì‹œë®¬ë ˆì´í„°</div>
</div>

<!-- ğŸ“˜ ê²½í—˜ì¹˜ ê³„ì‚°ê¸° (ì›ë˜ ì½”ë“œ ìœ ì§€) -->
<div id="exp" class="panel active">
  <h2>ğŸ“˜ ê²½í—˜ì¹˜ ê³„ì‚°ê¸°</h2>
  <div class="row"><label>í« ì´ë¦„</label><input id="petNameExp" type="text" placeholder="ì˜ˆ: í¬ì´ë¹„ìŠ¤"></div>
  <div class="row"><label>í˜„ì¬ ë ˆë²¨</label><input id="curLv" type="number" value="1"></div>
  <div class="row"><label>ëª©í‘œ ë ˆë²¨</label><input id="targetLv" type="number" value="30"></div>
  <div class="row"><label>ì „íˆ¬ë‹¹ ê²½í—˜ì¹˜</label><input id="expPerBattle" type="number" value="120"></div>
  <div class="row"><label>ë¶„ë‹¹ ì „íˆ¬ íšŸìˆ˜</label><input id="battlesPerMin" type="number" value="2"></div>
  <button id="calcExpBtn">ê²½í—˜ì¹˜ ê³„ì‚°</button>
  <div id="expResult" class="result"></div>
</div>

<!-- ğŸ² í« ì´ˆê¸°í™” ì‹œë®¬ë ˆì´í„° (Sê¸‰ ê¸°ë°˜, ì˜ˆì‹œ ì¶œë ¥ ì—†ìŒ) -->
<div id="sim" class="panel">
  <h2>ğŸ² í« ì´ˆê¸°í™” ì‹œë®¬ë ˆì´í„°</h2>

  <div class="row">
    <label>í« ì´ë¦„</label><input id="petNameSim" type="text" placeholder="ì˜ˆ: í¬ì´ë¹„ìŠ¤">
  </div>

  <div class="row">
    <label>ëœë¤ ì´ˆê¸°í™”</label><button id="generateBtn">ì •ìˆ˜ ëŠ¥ë ¥ì¹˜ ìƒì„±</button>
  </div>

  <div class="row">
    <label>Sê¸‰ ë°ì´í„°(JSON)</label>
    <input id="sgFile" type="file" accept=".json">
    <span class="muted">ë¡œì»¬ JSON ì—…ë¡œë“œ (ë„¤ê°€ ì“°ëŠ” Sê¸‰ ì¡°í•© ë°ì´í„°)</span>
  </div>

  <div id="simStats" class="result" style="display:none"></div>
  <hr>
  <div id="probHeader" class="muted"></div>
  <div id="probOutput"></div>
  <div id="noData" class="muted"></div>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ íƒ­ ì „í™˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
  });
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê²½í—˜ì¹˜ ê³„ì‚°ê¸° (ì› ì½”ë“œ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function expForLevel(lv){ return Math.pow(lv,3)*10; } // ì›ë˜ ì“°ë˜ ë‹¨ìˆœì‹ ìœ ì§€
document.getElementById('calcExpBtn').addEventListener('click', ()=>{
  const name=document.getElementById('petNameExp').value||'ì´ë¦„ ì—†ëŠ” í«';
  const curLv=+document.getElementById('curLv').value;
  const targetLv=+document.getElementById('targetLv').value;
  const expPerBattle=+document.getElementById('expPerBattle').value;
  const battlesPerMin=+document.getElementById('battlesPerMin').value;
  if(targetLv<=curLv){ document.getElementById('expResult').innerText='ëª©í‘œ ë ˆë²¨ì€ í˜„ì¬ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.'; return; }
  const needExp=expForLevel(targetLv)-expForLevel(curLv);
  const needBattles=Math.ceil(needExp/expPerBattle);
  const needMinutes=needBattles/battlesPerMin;
  const h=Math.floor(needMinutes/60), m=Math.round(needMinutes%60);
  document.getElementById('expResult').innerHTML=
    `<b>${name}</b> Lv.${curLv} â†’ Lv.${targetLv}<br>í•„ìš” ê²½í—˜ì¹˜: ${needExp.toLocaleString()}<br>ì „íˆ¬ ìˆ˜: ${needBattles.toLocaleString()}íšŒ<br>ì˜ˆìƒ ì‹œê°„: ${h}ì‹œê°„ ${m}ë¶„`;
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sê¸‰ ë°ì´í„° ì—…ë¡œë“œ ë° í™•ë¥  ê³„ì‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   JSON ìŠ¤í‚¤ë§ˆ(ì˜ˆì‹œ â€” í™”ë©´ì—” í‘œì‹œë˜ì§€ ì•ŠìŒ):
   [
     { "name":"í¬ì´ë¹„ìŠ¤", "hp":47, "atk":12, "def":7, "agi":4, "total":380, "grade8":57 },
     { "name":"í¬ì´ë¹„ìŠ¤", "hp":45, "atk":13, "def":6, "agi":5, "total":410, "grade8":46 },
     ...
   ]
   - nameì€ ì„ íƒì‚¬í•­. ì—†ìœ¼ë©´ ëª¨ë“  í«ì— ê³µí†µìœ¼ë¡œ ì‚¬ìš©
*/
let sgData = []; // ì—…ë¡œë“œëœ Sê¸‰ ì¡°í•© ë°ì´í„°

document.getElementById('sgFile').addEventListener('change', async (e)=>{
  const file=e.target.files?.[0]; if(!file) return;
  try{
    const text=await file.text();
    const json=JSON.parse(text);
    if(!Array.isArray(json)) throw new Error('JSON ë£¨íŠ¸ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤.');
    // ê²€ì¦: í•„ìš”í•œ í‚¤ê°€ ì—†ëŠ” ê²½ìš° í•„í„°ë§
    sgData = json.filter(o => Number.isFinite(+o.total) && Number.isFinite(+o.grade8)
                    && Number.isFinite(+o.hp) && Number.isFinite(+o.atk)
                    && Number.isFinite(+o.def) && Number.isFinite(+o.agi));
    renderFromS(); // ì—…ë¡œë“œ ì¦‰ì‹œ í˜„ì¬ ì…ë ¥/ëœë¤ê°’ ê¸°ì¤€ìœ¼ë¡œ ë Œë”
  }catch(err){
    sgData = [];
    document.getElementById('noData').innerText = 'JSON íŒŒì‹± ì‹¤íŒ¨: ' + err.message;
    document.getElementById('probOutput').innerHTML='';
    document.getElementById('probHeader').innerHTML='';
  }
});

/* ëœë¤ ì •ìˆ˜ ìƒì„± */
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

document.getElementById('generateBtn').addEventListener('click', ()=>{
  const hp=rand(40,55), atk=rand(10,14), def=rand(5,8), agi=rand(3,6);
  const name=document.getElementById('petNameSim').value||'ì´ë¦„ ì—†ëŠ” í«';
  const box=document.getElementById('simStats');
  box.style.display='block';
  box.innerHTML = `<b>${name}</b> ì´ˆê¸° ëŠ¥ë ¥ì¹˜ Â· ì²´ë ¥:${hp} / ê³µê²©ë ¥:${atk} / ë°©ì–´ë ¥:${def} / ìˆœë°œë ¥:${agi}`;
  renderFromS(name, {hp, atk, def, agi});
});

/* ì¡°í•©ë³„Â·ì „ì²´ í™•ë¥  ê³„ì‚° */
function getGlobalStats(list){
  let totalAll=0, grade8All=0;
  list.forEach(d=>{ totalAll+=d.total; grade8All+=d.grade8; });
  return { totalAll, grade8All };
}

function calcRates(list){
  const g=getGlobalStats(list);
  return list.map(c=>{
    const local = c.total? c.grade8/c.total : 0;
    const global= g.totalAll? c.grade8/g.totalAll : 0;
    return {...c, localRate:(local*100).toFixed(2)+'%', globalRate:(global*100).toFixed(3)+'%'};
  });
}

/* Sê¸‰ ê¸°ë°˜ ë Œë”ë§ (ì˜ˆì‹œ ë°ì´í„° ë¯¸ì¶œë ¥) */
function renderFromS(petNameInput='', stats=null){
  const petName = petNameInput || (document.getElementById('petNameSim').value||'');
  const header = document.getElementById('probHeader');
  const out    = document.getElementById('probOutput');
  const empty  = document.getElementById('noData');

  out.innerHTML=''; header.innerHTML=''; empty.innerText='';

  if(sgData.length===0){
    empty.innerText='Sê¸‰ ë°ì´í„°ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
    return;
  }

  // í« ì´ë¦„ì´ ë°ì´í„°ì— ìˆìœ¼ë©´ í•´ë‹¹ nameë§Œ, ì—†ìœ¼ë©´ ì „ì²´ ì‚¬ìš©
  let pool = sgData;
  if(petName){
    const named = sgData.filter(x => (x.name||'').trim()===petName.trim());
    if(named.length>0) pool = named;
  }

  // ì´ˆê¸°í™” ëœë¤ ëŠ¥ë ¥ì¹˜(stats)ê°€ ì£¼ì–´ì§€ë©´, í•´ë‹¹ Sê¸‰ ì¡°í•©ê³¼ "ê°™ì€ ì •ìˆ˜ ëŠ¥ë ¥ì¹˜"ë§Œ í•„í„°
  if(stats){
    pool = pool.filter(x => x.hp===stats.hp && x.atk===stats.atk && x.def===stats.def && x.agi===stats.agi);
  }

  if(pool.length===0){
    empty.innerText = 'í•´ë‹¹ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” Sê¸‰ ì¡°í•© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }

  const rates = calcRates(pool);
  const g = getGlobalStats(pool);
  header.innerHTML =
    `ì „ì²´ ê²½ìš°ì˜ ìˆ˜: <b>${g.totalAll.toLocaleString()}</b> | ì „ì²´ 8ë“±ê¸‰ ì¼€ì´ìŠ¤: <b>${g.grade8All.toLocaleString()}</b>`;

  rates.forEach((r,i)=>{
    const div=document.createElement('div');
    div.className='combo-box';
    div.innerHTML = `
      <div>#${i+1}</div>
      <div>
        <span>ì²´ë ¥: ${r.hp}</span>
        <span>ê³µê²©ë ¥: ${r.atk}</span>
        <span>ë°©ì–´ë ¥: ${r.def}</span>
        <span>ìˆœë°œë ¥: ${r.agi}</span>
      </div>
      <div class="muted">ì¡°í•© ë‚´ ê²½ìš°ì˜ ìˆ˜: ${(+r.total).toLocaleString()} / 8ë“±ê¸‰: ${(+r.grade8).toLocaleString()}</div>
      <div>â–¶ ì¡°í•©ë³„ 8ë“±ê¸‰ í™•ë¥ : <span class="prob">${r.localRate}</span><br>
          â–¶ ì „ì²´ ëŒ€ë¹„ ë¹„ì¤‘: <span class="prob">${r.globalRate}</span></div>`;
    out.appendChild(div);
  });
}
</script>
</body>
</html>
