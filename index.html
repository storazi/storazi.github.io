<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>노바 랜덤 펫 능력치 시뮬레이터</title>
<style>
body {
  font-family: Pretendard, system-ui, sans-serif;
  background: #0b1220;
  color: #eaf2ff;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}
.card {
  background: #121a2b;
  border: 1px solid #24324b;
  border-radius: 16px;
  padding: 24px;
  width: 640px;
  max-width: 95%;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
}
button {
  background: linear-gradient(180deg,#6aa0ff,#3d76e6);
  color: #fff;
  font-weight: 700;
  border: none;
  border-radius: 10px;
  padding: 10px 14px;
  cursor: pointer;
}
#result {
  white-space: pre-wrap;
  line-height: 1.6;
  margin-top: 16px;
}
</style>
</head>
<body>
<div class="card">
  <h2>🎲 노바 펫 랜덤 능력치 시뮬레이터 (전수탐색 기반)</h2>
  <label>펫 이름: <input id="petName" placeholder="예: 갈푸스"></label>
  <button id="runBtn">시뮬레이션 실행 (5회)</button>
  <div id="result"></div>
</div>

<script>
let PETS={}, RANK8={};

// ✅ GitHub Pages 호환 경로
async function loadData(){
  try {
    PETS = await fetch("./data/pets.json").then(r=>r.json());
    RANK8 = await fetch("./data/guaranteed_rank8.full.json").then(r=>r.json());
    console.log("✅ 데이터 로드 완료:", Object.keys(PETS).length, "pets");
  } catch(e){
    console.error("❌ 데이터 로드 실패", e);
    alert("데이터 파일을 찾을 수 없습니다.\n/data 폴더 확인 필요!");
  }
}
loadData();

// 🎯 전수탐색 엔진
function enumerate_jjyal(k, u, obs){
  let matches = 0, rank8 = 0;
  for(let ar=-2; ar<=2; ar++){
    for(let dr=-2; dr<=2; dr++){
      for(let gr=-2; gr<=2; gr++){
        for(let hr=-2; hr<=2; hr++){
          for(let ab=0; ab<=10; ab++){
            for(let db=0; db<=10; db++){
              for(let gb=0; gb<=10; gb++){
                const hb = 10-ab-db-gb;
                if(hb<0||hb>10) continue;
                const baseA=u.atk+ar+ab;
                const baseD=u.def+dr+db;
                const baseG=u.agi+gr+gb;
                const baseH=u.hp +hr+hb;
                const fac=k/100;
                const iA=baseA*fac, iD=baseD*fac, iG=baseG*fac, iH=baseH*fac;
                const calcAtk=Math.floor(iH*0.1+iA+iD*0.1+iG*0.05);
                const calcDef=Math.floor(iH*0.1+iA*0.1+iD+iG*0.05);
                const calcAgi=Math.floor(iG);
                const calcHp =Math.floor(iH*4+iA+iD+iG);
                if(calcAtk===obs[1]&&calcDef===obs[2]&&calcAgi===obs[3]&&calcHp===obs[0]){
                  matches++;
                  const sum = ar+dr+gr+hr;
                  if(sum===8) rank8++;
                }
              }
            }
          }
        }
      }
    }
  }
  return {matches, rank8, prob: matches?(rank8/matches*100):0};
}

// 🎲 랜덤 능력치 생성
function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function randomStat(pet){
  const {k,u}=pet;
  const ar=randomInt(-2,2),dr=randomInt(-2,2),gr=randomInt(-2,2),hr=randomInt(-2,2);
  const ab=randomInt(0,10);
  const db=randomInt(0,10-ab);
  const gb=randomInt(0,10-ab-db);
  const hb=10-ab-db-gb;
  const baseA=u.atk+ar+ab, baseD=u.def+dr+db, baseG=u.agi+gr+gb, baseH=u.hp+hr+hb;
  const fac=k/100;
  const iA=baseA*fac, iD=baseD*fac, iG=baseG*fac, iH=baseH*fac;
  return [
    Math.floor(iH*4+iA+iD+iG), // HP
    Math.floor(iH*0.1+iA+iD*0.1+iG*0.05), // ATK
    Math.floor(iH*0.1+iA*0.1+iD+iG*0.05), // DEF
    Math.floor(iG) // AGI
  ];
}

// ⚙️ 실행
document.getElementById("runBtn").onclick=async()=>{
  const name=document.getElementById("petName").value.trim();
  const resBox=document.getElementById("result");
  if(!name) return alert("펫 이름을 입력하세요.");
  const pet=PETS[name];
  if(!pet) return alert("해당 펫 데이터가 없습니다.");
  const r8 = RANK8[name]?.obs_100_rank8 || [];

  let text=`🐉 [${name}] 랜덤 시뮬레이션 (5회)\n\n`;
  const {k,u}=pet;
  for(let i=1;i<=5;i++){
    const obs=randomStat(pet);
    const found=r8.some(arr=>arr[0]===obs[0]&&arr[1]===obs[1]&&arr[2]===obs[2]&&arr[3]===obs[3]);
    let line=`#${i}  체력 ${obs[0]} / 공격 ${obs[1]} / 방어 ${obs[2]} / 순발 ${obs[3]}\n`;
    if(found){
      line+=`    🎯 확정 세트 (8등급 100%)\n`;
    }else{
      const calc=enumerate_jjyal(k,u,obs);
      line+=`    🎯 일반 확률: ${calc.prob.toFixed(2)}%\n`;
    }
    text+=line+"\n";
  }
  resBox.textContent=text;
};
</script>
</body>
</html>
