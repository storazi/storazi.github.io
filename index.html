<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>StoneAge 통합 계산기</title>
<style>
  :root{
    --bg:#0b1220; --panel:#121a2b; --soft:#1c2538; --ring:#24324b;
    --text:#eaf2ff; --muted:#a9b5cc; --accent:#6aa0ff;
  }
  *{box-sizing:border-box;transition:all .15s ease-in-out;}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:Pretendard,system-ui,sans-serif;
    display:flex;flex-direction:column;align-items:center;
    min-height:100vh;padding:20px;
  }
  .tabs{display:flex;gap:10px;margin-bottom:20px;}
  .tab-btn{
    background:var(--soft);border:1px solid var(--ring);
    padding:10px 16px;border-radius:10px;color:var(--text);
    cursor:pointer;font-weight:700;
  }
  .tab-btn.active{background:var(--accent);color:#fff;}
  section{display:none;width:100%;max-width:1100px;}
  section.active{display:block;}
  .card{
    background:linear-gradient(180deg,#121a2b 0%,#0e1626 100%);
    border:1px solid var(--ring);border-radius:20px;
    padding:24px;box-shadow:0 10px 25px rgba(0,0,0,.3);margin-bottom:20px;
  }
  input{
    background:#0e1626;border:1px solid var(--ring);
    color:var(--text);border-radius:10px;padding:10px;width:100%;
  }
  button{
    background:linear-gradient(180deg,#6aa0ff,#3d76e6);
    border:none;color:#fff;padding:10px 14px;border-radius:10px;
    cursor:pointer;font-weight:700;
  }
  .stat{
    background:var(--soft);
    padding:12px;border-radius:12px;
    margin-top:10px;line-height:1.6;
    border:1px solid var(--ring);
  }
  .muted{color:var(--muted);}
  .highlight{color:var(--accent);font-weight:700;}
</style>
</head>
<body>

<h1>🪨 StoneAge 통합 계산기</h1>
<div class="tabs">
  <div class="tab-btn active" data-tab="exp">📘 경험치 계산기</div>
  <div class="tab-btn" data-tab="pet">🎲 펫 능력치 시뮬레이터</div>
</div>

<!-- 📘 경험치 계산기 -->
<section id="exp" class="active">
  <div class="card">
    <h2>레벨업 계산기</h2>
    <label>현재 레벨 <input id="currentLevel" type="number"></label><br>
    <label>현재 진행도(%) <input id="currentPercent" type="number"></label><br>
    <label>목표 레벨 <input id="targetLevel" type="number"></label><br>
    <label>시간당 획득 경험치 <input id="xpPerHour" type="number"></label><br>
    <button id="run">계산</button>
    <div id="expResult" class="stat"></div>
  </div>
</section>

<!-- 🎲 펫 능력치 시뮬레이터 -->
<section id="pet">
  <div class="card">
    <h2>펫 능력치 시뮬레이터 (정수형)</h2>
    <label>펫 이름 <input id="petName" placeholder="예: 갈푸스"></label><br>
    <button id="petOnce">초기화 1회</button>
    <button id="petFive">초기화 5회</button>
    <div id="petResult"></div>
  </div>
</section>

<script>
// 🌙 탭 전환
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// 📘 경험치 계산기
const EXP_TABLE={0:0,1:2,2:6,3:17,4:37,5:67,6:111,7:169,8:247,9:344,10:464,11:609,12:783,13:985,14:1221,15:1491,16:1799,17:2145,18:2535,19:2968,20:3448,21:3977,22:4559,23:5193,24:5885,25:6635,26:7447,27:8321,28:9263,29:10272,30:11352};
const getTotalExp=(s,t)=>{let sum=0;for(let lv=s;lv<t;lv++){if(EXP_TABLE[lv])sum+=EXP_TABLE[lv];}return sum;};
document.getElementById('run').onclick=()=>{
  const c=+document.getElementById('currentLevel').value;
  const p=+document.getElementById('currentPercent').value||0;
  const t=+document.getElementById('targetLevel').value;
  const x=+document.getElementById('xpPerHour').value;
  if(!c||!t||!x)return alert('입력 부족');
  const remain=EXP_TABLE[c]*(1-p/100)+getTotalExp(c+1,t);
  const hours=remain/x;
  document.getElementById('expResult').innerHTML=`남은 경험치 ${remain.toLocaleString()} / 예상 ${hours.toFixed(2)} 시간`;
};

// 🎲 정수형 펫 시뮬레이터
let PETS={},RANK8={};
async function loadData(){
  try{
    PETS=await fetch("pets.json").then(r=>r.json());
    RANK8=await fetch("guaranteed_rank8.full.json").then(r=>r.json());
    console.log("데이터 로드 완료");
  }catch(e){console.error(e);}
}
loadData();

function randomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

function simulateIntStats(petName,times=1){
  const pet=PETS[petName];
  const rank=RANK8[petName];
  const res=document.getElementById("petResult");
  if(!pet||!rank){res.innerHTML=`❌ '${petName}' 데이터 없음`;return;}
  const k=pet.k??24;
  const u=pet.u;

  let html=`<p class="muted">🎯 8등급 기준 표본 수: <b>${rank.count??0}</b></p>`;
  for(let i=0;i<times;i++){
    // 오차(±2)와 분배치(총합 10)
    const ar=randomInt(-2,2),dr=randomInt(-2,2),gr=randomInt(-2,2),hr=randomInt(-2,2);
    const ab=randomInt(0,10);
    const db=randomInt(0,10-ab);
    const gb=randomInt(0,10-ab-db);
    const hb=10-ab-db-gb;

    const baseA=u.atk+ar+ab;
    const baseD=u.def+dr+db;
    const baseG=u.agi+gr+gb;
    const baseH=u.hp +hr+hb;

    const fac=k/100;
    const iA=baseA*fac, iD=baseD*fac, iG=baseG*fac, iH=baseH*fac;

    const calcAtk=Math.floor(iH*0.1+iA+iD*0.1+iG*0.05);
    const calcDef=Math.floor(iH*0.1+iA*0.1+iD+iG*0.05);
    const calcAgi=Math.floor(iG);
    const calcHp =Math.floor(iH*4+iA+iD+iG);

    // 확률 계산 (rank 데이터 존재 시)
    const rate=(rank.rate??rank.count??0);
    html+=`
      <div class="stat">
        #${i+1}<br>
        체력: <b>${calcHp}</b> / 공격력: <b>${calcAtk}</b> / 방어력: <b>${calcDef}</b> / 순발력: <b>${calcAgi}</b><br>
        <span class="muted">해당 조합 8등급 확률:</span> <span class="highlight">${rate.toFixed(2)}%</span>
      </div>`;
  }
  res.innerHTML=html;
}

document.getElementById("petOnce").onclick=()=>simulateIntStats(document.getElementById("petName").value.trim(),1);
document.getElementById("petFive").onclick=()=>simulateIntStats(document.getElementById("petName").value.trim(),5);
</script>
</body>
</html>
